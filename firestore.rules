rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Sessions are readable by clients so they can show live countdowns
    match /sessions/{sessionId} {
      allow read: if true;
      // Allow create unless the supplied subjectId already exists and is owned by a different teacher
      allow create: if !(request.resource.data.subjectId is string && exists(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId))
                          && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacher != request.resource.data.teacher);
      allow update: if true; // allow marking expired or admin updates

      // Attendance docs: one document per roll number inside the session
      match /attendance/{roll} {
        // Allow CREATE only if the session hasn't expired yet and the attendance doc
        // does not already exist. This prevents overwriting an existing attendance
        // and prevents marking attendance after expiry.
        allow create: if get(/databases/$(database)/documents/sessions/$(sessionId)).data.expiryTimeMs > request.time.toMillis()
                       && !exists(/databases/$(database)/documents/sessions/$(sessionId)/attendance/$(roll));

        // Disallow updates and deletes to attendance documents so a successful
        // write is final and cannot be tampered with by clients.
        allow update, delete: if false;

        allow read: if true;
      }
    }

    // Subjects collection stores assignment of subject -> teacher and is create-only
    match /subjects/{subjectId} {
      allow read: if true;
      // Only allow creation when the document does not already exist (prevents reassignments via client)
      allow create: if !exists(/databases/$(database)/documents/subjects/$(subjectId));
      allow update, delete: if false;
    }

      // Devices collection records which client/device marked attendance (used
      // to prevent the same device from marking multiple different rolls). Creation
      // allowed only while session is active.
      match /devices/{deviceId} {
        allow create: if get(/databases/$(database)/documents/sessions/$(sessionId)).data.expiryTimeMs > request.time.toMillis();
        allow read: if true;
        allow update, delete: if false;
      }
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}