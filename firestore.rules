rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Sessions are readable by clients so they can show live countdowns
    match /sessions/{sessionId} {
      allow read: if true;
      allow create: if true; // teachers (or trusted processes) create sessions
      allow update: if true; // allow marking expired or admin updates

      // Attendance docs: one document per roll number inside the session
      match /attendance/{roll} {
        // Allow CREATE only if the session hasn't expired yet and the attendance doc
        // does not already exist. This prevents overwriting an existing attendance
        // and prevents marking attendance after expiry.
        allow create: if get(/databases/$(database)/documents/sessions/$(sessionId)).data.expiryTimeMs > request.time.toMillis()
                       && !exists(/databases/$(database)/documents/sessions/$(sessionId)/attendance/$(roll));

        // Disallow updates and deletes to attendance documents so a successful
        // write is final and cannot be tampered with by clients.
        allow update, delete: if false;

        allow read: if true;
      }

      // Devices collection records which client/device marked attendance (used
      // to prevent the same device from marking multiple different rolls). Creation
      // allowed only while session is active.
      match /devices/{deviceId} {
        allow create: if get(/databases/$(database)/documents/sessions/$(sessionId)).data.expiryTimeMs > request.time.toMillis();
        allow read: if true;
        allow update, delete: if false;
      }
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}